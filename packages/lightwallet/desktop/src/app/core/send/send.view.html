<app-lock-screen fullScreen *ngIf="!hasUnlockedWallet"></app-lock-screen>
<div class="sendMerit">
  <div class="container--inner">

    <div class="sendMerit__header title--primary">
      <p>Send Merit</p>
    </div>

    <error-message *ngIf="error">{{ error }}</error-message>
    <error-message *ngIf="success" class="success">
      <!-- TODO(ibby) create success-message & info-message components... or just a global message component with different styles -->
      Transaction successfully sent
      <div *ngIf="easySendUrl">
        Your global send URL is ready, now you can share it:
        <div class="easysend-url-container" [clip]="easySendUrl">
          <small class="click_to_copy">Click to copy</small>
          {{ easySendUrl }}
        </div>
      </div>
    </error-message>

    <loading-spinner *ngIf="sending"></loading-spinner>
    <send-tour *ngIf="showTour" (hideTour)="hideTour()"></send-tour>
    <div class="sendMerit__content">

      <form class="sendMerit__form" [formGroup]="formData" (ngSubmit)="submit.next()">
        <div class="sendMerit__form__group">
          <label class="ui-label">Amount</label>
          <div class="ui-input__wrapper ui-input__wrapper--mrt">
            <input type="number" name="" formControlName="amountMrt" placeholder="0"
                   class="ui-input ui-input--form ui-input--text">
            <div class="ui-input__addon">MRT</div>
          </div>
          <div class="input-errors" [hidden]="!amountMrt.dirty || amountMrt.valid">
            <div [hidden]="!amountMrt.hasError('required')">
                <span class="tooltip-error">
                  <span>
                    Amount is required
                  </span>
                </span>
            </div>
            <div [hidden]="amountMrt.hasError('required') || !amountMrt.hasError('InvalidAmount')">
                <span class="tooltip-error">
                  <span>
                    Invalid amount
                  </span>
                </span>
            </div>
          </div>
          <div class="ui-input__wrapper ui-input__wrapper--currency" *ngIf="availableCurrencies?.length">
            <input type="text" name="" [value]="amountFiat$ | async" disabled
                   class="ui-input ui-input--form ui-input--text">
            <div class="ui-input__addon">
              <app-select (selectionEvent)="selectCurrency($event)" [selected]="selectedCurrency.value"
                          [input]="availableCurrencies"
                          cssClass="ui-button ui-button--transparent ui-button--select-currency ui-button--md ui-button--with-caret"></app-select>
            </div>
          </div>
        </div>
        <div class="sendMerit__form__group">
          <div class="sendMerit__form__group__column sendMerit__form_group__column--70">
            <label for="feeIncluded" class="ui-label">Include fee in the amount:</label>
          </div>
          <div class="sendMerit__form__group__column sendMerit__form_group__column--30">
            <div class="ui-checkbox">
              <input type="checkbox" name="feeIncluded" id="feeIncluded" formControlName="feeIncluded">
              <span class="ui-checkbox__switcher"></span>
            </div>
          </div>
        </div>
        <div class="sendMerit__form__group" [hidden]="amountMrt.pristine || amountMrt.invalid">
          <label class="ui-label">Send from</label>
          <app-select (selectionEvent)="selectWallet($event)" [selected]="wallet.value" [input]="wallets$ | async"
                      cssClass="ui-input ui-input--select ui-input--form"></app-select>
          <label class="ui-label available-amount-label" *ngIf="wallet.valid">
            {{ wallet.value.status.spendableAmount | toMRT }}, {{ wallet.value.status.availableInvites || 0 }}
            invites available
          </label>
        </div>

        <div class="selectMethod" [hidden]="amountMrt.pristine || amountMrt.invalid">
          <button (click)="updateTxType('classic')" type="button" role="button" class="selectMethod_item"
                  [class.active]="type.value === 'classic'">
            <span class="title">
              Send via ClassicSend
            </span>
            <span class="description">
              Send to a Merit address
            </span>
          </button>
          <button (click)="updateTxType('easy')" [disabled]="!wallet.value?.status?.availableInvites" type="button"
                  role="button" class="selectMethod_item" [class.active]="type.value === 'easy'">
            <span class="title">
              Send via GlobalSend
            </span>
            <span class="description">
              Not sure if they have a Merit address?
              <span class="error" *ngIf="!wallet.value?.status?.availableInvites">
                You don't have an available invite to use GlobalSend, please select another wallet or use ClassicSend.
              </span>
            </span>
          </button>
        </div>

        <ng-container *ngIf="amountMrt.dirty && amountMrt.valid">
          <ng-container *ngIf="type.value === 'classic'; else easySend">
            <div class="sendMerit__form__group">
              <label class="ui-label">Send to address / alias</label>
              <input type="text" name="" value="" placeholder="Paste address / alias here"
                     class="ui-input ui-input--form ui-input--text" formControlName="address">
              <div class="input-errors" [hidden]="!address.dirty || address.valid">
                <div>
                  <span class="tooltip-error">
                    <span>
                      {{ address.errors | addressErrorMessage }}
                    </span>
                  </span>
                </div>
              </div>
            </div>
          </ng-container>
          <ng-template #easySend>
            <div class="sendMerit__form__group">
              <label class="ui-label">Password &nbsp;
                <small>(optional)</small>
              </label>
              <input type="password" class="ui-input ui-input--form ui-input--text" formControlName="password">
              <div class="info">
                <span class="icon">
                  <img src="/assets/v1/icons/ui/aside-navigation/info.svg" alt="">
                </span>
                <p>
                  You will see a link after confirming the transaction that you can share with your recipient.
                </p>
              </div>
            </div>
          </ng-template>
        </ng-container>

        <div class="sendMerit__form__group">
          <button type="submit" class="ui-button ui-button--blue"
                  [disabled]="!canSend">
            Send Merit
          </button>
        </div>
      </form>

      <div class="sendMerit__totals">
        <div class="sendMerit__form__group">
          <div class="sendMerit__totals__table">
            <loading-spinner-small *ngIf="receiptLoading; else hasData"></loading-spinner-small>
            <ng-template #hasData>
              <ng-container *ngIf="receipt$ | async as receipt">
                <div class="sendMerit__totals__table--top">
                  <label class="ui-label">
                    Receipt
                  </label>
                  <div class="sendMerit__totals__table__row sendMerit__totals__table__row--strong">
                    <div class="sendMerit__totals__table__column">
                      Send to
                    </div>
                    <div class="sendMerit__totals__table__column" *ngIf="type.value == 'classic'">
                      {{ (address.value | address) || '...' }}
                    </div>
                    <div class="sendMerit__totals__table__column" *ngIf="type.value == 'easy'">
                      GlobalSend
                    </div>
                  </div>
                  <div class="sendMerit__totals__table__row">
                    <div class="sendMerit__totals__table__column">
                      Amount
                    </div>
                    <div class="sendMerit__totals__table__column">
                      {{ receipt.amount | toMRT }}
                    </div>
                  </div>
                  <div class="sendMerit__totals__table__row sendMerit__totals__table__row--strong">
                    <div class="sendMerit__totals__table__column">
                      Total
                    </div>
                    <div class="sendMerit__totals__table__column">
                      {{ receipt.total | toMRT }}
                    </div>
                  </div>
                </div>
                <div class="sendMerit__totals__table--bottom">
                  <div class="sendMerit__totals__table__row sendMerit__totals__table__row--devider">
                  </div>
                  <div class="sendMerit__totals__table__row">
                    <div class="sendMerit__totals__table__column">In Wallet</div>
                    <div class="sendMerit__totals__table__column">
                      {{ receipt.inWallet | toMRT }}
                    </div>
                  </div>
                  <div class="sendMerit__totals__table__row">
                    <div class="sendMerit__totals__table__column">Total Remaining</div>
                    <div class="sendMerit__totals__table__column">
                      {{ receipt.remaining | toMRT }}
                    </div>
                  </div>
                </div>
              </ng-container>
            </ng-template>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
